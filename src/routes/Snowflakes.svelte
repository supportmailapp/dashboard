<script lang="ts">
  import { browser } from "$app/environment";
  import { getSnowflakes } from "$lib/stores/SnowflakeControls.svelte";
  import { Portal } from "bits-ui";
  import { onDestroy, onMount } from "svelte";

  const snowflakeCfg = getSnowflakes();
  let intensity = $derived(snowflakeCfg.intensity);

  let canvas = $state<HTMLCanvasElement>(undefined as unknown as HTMLCanvasElement);
  let ctx: CanvasRenderingContext2D;
  let snowflakes = $state<any[]>([]);
  let animationId: number;
  let snowflakeImage: HTMLImageElement[];

  // SVG snowflake designs
  const snowflakeSVGs = [
    `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5L12 2zm0 8l1 3 3 1-3 1-1 3-1-3-3-1 3-1 1-3zm6 2l.75 2.25L21 15l-2.25.75L18 18l-.75-2.25L15 15l2.25-.75L18 12zm-12 0l.75 2.25L9 15l-2.25.75L6 18l-.75-2.25L3 15l2.25-.75L6 12z"/></svg>`,
    `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M12 1l.866 2.598L15 4.464l-2.134.866L12 8l-.866-2.598L9 4.536l2.134-.866L12 1zm0 8l.866 2.598L15 12.464l-2.134.866L12 16l-.866-2.598L9 12.536l2.134-.866L12 9zm0 8l.866 2.598L15 20.464l-2.134.866L12 24l-.866-2.598L9 20.536l2.134-.866L12 17zM4 5l.866 2.598L7 8.464 4.866 9.33 4 12l-.866-2.598L1 8.536l2.134-.866L4 5zm16 0l.866 2.598L23 8.464l-2.134.866L20 12l-.866-2.598L17 8.536l2.134-.866L20 5zm-8 7l.433 1.299L14 14.232l-1.567.433L12 16l-.433-1.299L10 14.268l1.567-.433L12 12z"/></svg>`,
    `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M12 2v20M2 12h20M5.636 5.636l12.728 12.728M18.364 5.636L5.636 18.364M12 5l-1.5 4.5L6 12l4.5 1.5L12 18l1.5-4.5L18 12l-4.5-1.5L12 5z"/></svg>`,
    `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="white"><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="6" r="1"/><circle cx="12" cy="18" r="1"/><circle cx="6" cy="12" r="1"/><circle cx="18" cy="12" r="1"/><circle cx="8" cy="8" r="0.8"/><circle cx="16" cy="8" r="0.8"/><circle cx="8" cy="16" r="0.8"/><circle cx="16" cy="16" r="0.8"/><line x1="12" y1="2" x2="12" y2="22" stroke="white" stroke-width="0.5"/><line x1="2" y1="12" x2="22" y2="12" stroke="white" stroke-width="0.5"/><line x1="4" y1="4" x2="20" y2="20" stroke="white" stroke-width="0.5"/><line x1="20" y1="4" x2="4" y2="20" stroke="white" stroke-width="0.5"/></g></svg>`,
    `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2100" height="2100" viewBox="0 0 2100 2100">
<path fill-rule="nonzero" fill="white" fill-opacity="1" d="M 1026.601562 337.5 L 1026.601562 402.660156 L 1011.070312 392.660156 L 991.480469 379.941406 L 966.105469 419.28125 L 985.71875 431.929688 L 1026.601562 458.328125 L 1026.601562 538.160156 L 969.769531 486.789062 L 952.40625 471.140625 L 921.082031 505.851562 L 938.425781 521.519531 L 1026.601562 601.160156 L 1026.601562 744.851562 L 853.695312 576.101562 L 850.777344 817.691406 L 749.1875 716.089844 L 755.191406 597.378906 L 756.382812 574.070312 L 709.742188 571.671875 L 708.550781 595 L 704.609375 671.519531 L 648.191406 615.101562 L 658.449219 567.53125 L 663.359375 544.699219 L 617.628906 534.789062 L 612.703125 557.691406 L 608.816406 575.71875 L 579.257812 546.171875 L 562.75 529.660156 L 529.664062 562.679688 L 546.167969 579.25 L 575.726562 608.808594 L 557.695312 612.699219 L 534.867188 617.621094 L 544.703125 663.359375 L 567.53125 658.371094 L 615.0625 648.148438 L 671.519531 704.609375 L 595.003906 708.550781 L 571.675781 709.660156 L 574.074219 756.371094 L 597.386719 755.191406 L 716.097656 749.179688 L 817.691406 850.769531 L 576.101562 853.691406 L 744.875 1026.609375 L 601.175781 1026.609375 L 521.5 938.351562 L 505.847656 921 L 471.140625 952.398438 L 486.792969 969.769531 L 538.175781 1026.609375 L 458.332031 1026.609375 L 431.9375 985.710938 L 419.277344 966.101562 L 379.996094 991.480469 L 392.65625 1011.070312 L 402.695312 1026.609375 L 337.5 1026.609375 L 337.5 1073.398438 L 402.695312 1073.398438 L 392.65625 1088.921875 L 379.996094 1108.515625 L 419.277344 1133.890625 L 431.9375 1114.28125 L 458.296875 1073.398438 L 538.15625 1073.398438 L 486.792969 1130.230469 L 471.140625 1147.59375 L 505.847656 1178.933594 L 521.5 1161.570312 L 601.15625 1073.398438 L 744.851562 1073.398438 L 576.097656 1246.300781 L 817.6875 1249.21875 L 716.09375 1350.8125 L 597.382812 1344.734375 L 574.070312 1343.617188 L 571.671875 1390.257812 L 595.003906 1391.46875 L 671.515625 1395.390625 L 615.097656 1451.8125 L 567.527344 1441.550781 L 544.699219 1436.640625 L 534.863281 1482.371094 L 557.691406 1487.296875 L 575.726562 1491.183594 L 546.167969 1520.742188 L 529.660156 1537.246094 L 562.75 1570.335938 L 579.257812 1553.828125 L 608.816406 1524.273438 L 612.699219 1542.304688 L 617.625 1565.152344 L 663.355469 1555.296875 L 658.449219 1532.46875 L 648.1875 1484.898438 L 704.605469 1428.480469 L 708.546875 1504.996094 L 709.738281 1528.324219 L 756.378906 1525.949219 L 755.1875 1502.617188 L 749.183594 1383.90625 L 850.777344 1282.3125 L 853.691406 1523.902344 L 1026.589844 1355.144531 L 1026.589844 1498.863281 L 938.421875 1578.5 L 921.078125 1594.171875 L 952.402344 1628.878906 L 969.765625 1613.207031 L 1026.589844 1561.84375 L 1026.589844 1641.667969 L 985.714844 1668.082031 L 966.101562 1680.722656 L 991.476562 1720.003906 L 1011.070312 1707.34375 L 1026.589844 1697.304688 L 1026.589844 1762.5 L 1073.398438 1762.5 L 1073.398438 1697.304688 L 1088.929688 1707.34375 L 1108.519531 1720.003906 L 1133.890625 1680.722656 L 1114.28125 1668.082031 L 1073.398438 1641.667969 L 1073.398438 1561.84375 L 1130.230469 1613.207031 L 1147.589844 1628.878906 L 1178.921875 1594.171875 L 1161.570312 1578.5 L 1073.398438 1498.863281 L 1073.398438 1355.144531 L 1246.308594 1523.902344 L 1249.21875 1282.3125 L 1350.808594 1383.90625 L 1344.808594 1502.617188 L 1343.621094 1525.949219 L 1390.261719 1528.324219 L 1391.46875 1504.996094 L 1395.390625 1428.480469 L 1451.808594 1484.898438 L 1441.550781 1532.46875 L 1436.640625 1555.296875 L 1482.371094 1565.152344 L 1487.300781 1542.304688 L 1491.179688 1524.273438 L 1520.738281 1553.828125 L 1537.25 1570.335938 L 1570.339844 1537.246094 L 1524.269531 1491.183594 L 1542.308594 1487.296875 L 1565.148438 1482.371094 L 1555.300781 1436.640625 L 1532.46875 1441.550781 L 1484.898438 1451.8125 L 1428.480469 1395.390625 L 1505 1391.46875 L 1528.320312 1390.257812 L 1525.949219 1343.617188 L 1502.621094 1344.734375 L 1383.910156 1350.8125 L 1282.308594 1249.21875 L 1523.898438 1246.300781 L 1355.148438 1073.398438 L 1498.839844 1073.398438 L 1578.5 1161.570312 L 1594.148438 1178.933594 L 1628.878906 1147.59375 L 1613.210938 1130.230469 L 1561.839844 1073.398438 L 1641.699219 1073.398438 L 1668.078125 1114.28125 L 1680.71875 1133.890625 L 1720 1108.515625 L 1707.339844 1088.921875 L 1697.308594 1073.398438 L 1762.5 1073.398438 L 1762.5 1026.609375 L 1697.308594 1026.609375 L 1707.339844 1011.070312 L 1720 991.480469 L 1680.71875 966.101562 L 1668.078125 985.710938 L 1641.671875 1026.609375 L 1561.820312 1026.609375 L 1613.210938 969.769531 L 1628.878906 952.398438 L 1594.148438 921 L 1578.5 938.351562 L 1498.820312 1026.609375 L 1355.128906 1026.609375 L 1523.898438 853.691406 L 1282.308594 850.769531 L 1383.910156 749.179688 L 1502.621094 755.191406 L 1525.949219 756.371094 L 1528.320312 709.660156 L 1505 708.550781 L 1428.480469 704.609375 L 1484.941406 648.148438 L 1532.46875 658.371094 L 1555.300781 663.359375 L 1565.148438 617.621094 L 1542.308594 612.699219 L 1524.269531 608.808594 L 1553.828125 579.25 L 1570.339844 562.679688 L 1537.25 529.660156 L 1520.738281 546.171875 L 1491.179688 575.71875 L 1487.300781 557.691406 L 1482.371094 534.789062 L 1436.640625 544.699219 L 1441.550781 567.53125 L 1451.808594 615.101562 L 1395.390625 671.519531 L 1391.46875 595 L 1390.261719 571.671875 L 1343.621094 574.070312 L 1344.808594 597.378906 L 1350.808594 716.089844 L 1249.21875 817.691406 L 1246.308594 576.101562 L 1073.398438 744.851562 L 1073.398438 601.160156 L 1161.570312 521.519531 L 1178.921875 505.851562 L 1147.589844 471.140625 L 1130.230469 486.789062 L 1073.398438 538.160156 L 1073.398438 458.328125 L 1114.28125 431.929688 L 1133.890625 419.28125 L 1108.519531 379.941406 L 1088.929688 392.660156 L 1073.398438 402.660156 L 1073.398438 337.5 Z M 899.148438 685.699219 L 1026.601562 810.179688 L 1026.601562 969.691406 C 1020.699219 971.429688 1015.058594 973.75 1009.769531 976.679688 L 896.953125 863.859375 Z M 1200.859375 685.699219 L 1203.050781 863.859375 L 1090.230469 976.679688 C 1084.941406 973.75 1079.300781 971.429688 1073.410156 969.691406 L 1073.410156 810.179688 Z M 863.882812 896.96875 L 976.683594 1009.769531 C 973.75 1015.070312 971.414062 1020.710938 969.675781 1026.609375 L 810.234375 1026.609375 L 685.777344 899.160156 Z M 1236.121094 896.96875 L 1414.300781 899.160156 L 1289.808594 1026.621094 L 1130.328125 1026.621094 C 1128.589844 1020.710938 1126.25 1015.070312 1123.320312 1009.769531 Z M 1050 1013.039062 C 1070.691406 1013.039062 1086.960938 1029.320312 1086.960938 1050 C 1086.960938 1070.691406 1070.691406 1086.960938 1050 1086.960938 C 1029.320312 1086.960938 1013.050781 1070.691406 1013.050781 1050 C 1013.050781 1029.320312 1029.320312 1013.039062 1050 1013.039062 Z M 810.195312 1073.410156 L 969.675781 1073.410156 C 971.414062 1079.300781 973.753906 1084.941406 976.683594 1090.230469 L 863.917969 1202.992188 L 685.777344 1200.855469 Z M 1130.328125 1073.410156 L 1289.808594 1073.410156 L 1414.230469 1200.855469 L 1236.078125 1202.992188 L 1123.320312 1090.230469 C 1126.25 1084.941406 1128.589844 1079.300781 1130.328125 1073.398438 Z M 1009.769531 1123.316406 C 1015.058594 1126.25 1020.699219 1128.570312 1026.601562 1130.308594 L 1026.601562 1289.804688 L 899.148438 1414.226562 L 896.953125 1236.136719 Z M 1090.230469 1123.316406 L 1203.050781 1236.136719 L 1200.859375 1414.226562 L 1073.398438 1289.804688 L 1073.398438 1130.308594 C 1079.300781 1128.570312 1084.941406 1126.25 1090.230469 1123.316406 Z M 1090.230469 1123.316406 "/>
</svg>
`,
  ];

  $effect(() => {
    const count = Math.round((intensity / 10) * 200);
    updateSnowflakes(count);
  });

  function updateSnowflakes(count: number) {
    if (!canvas || !browser) return;

    if (count > snowflakes.length) {
      const toAdd = count - snowflakes.length;
      for (let i = 0; i < toAdd; i++) {
        snowflakes.push(createSnowflake());
      }
    } else if (count < snowflakes.length) {
      snowflakes = snowflakes.slice(0, count);
    }
  }

  function createSnowflake() {
    return {
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: Math.random() * 15 + 8,
      speed: Math.random() * 1 + 0.5,
      wind: Math.random() * 0.5 - 0.25,
      rotation: Math.random() * 360,
      rotationSpeed: Math.random() * 2 - 1,
      svgIndex: Math.floor(Math.random() * snowflakeSVGs.length),
    };
  }

  /**
   * Converts an SVG string into an HTMLImageElement asynchronously.
   *
   * @param svgString - The SVG markup as a string to be converted into an image
   * @param size - The width and height dimensions in pixels for the resulting image
   * @returns A Promise that resolves with the loaded HTMLImageElement
   *
   * @description
   * This function is async because the Image element requires time to load the SVG data
   * from the object URL. The Promise wrapper ensures the caller waits until the `onload`
   * event fires before receiving the fully loaded image. Without the async/Promise pattern,
   * the image would be returned before it finished loading, making it unusable.
   */
  async function loadSVGAsImage(svgString: string, size: number): Promise<HTMLImageElement> {
    return new Promise((resolve) => {
      const blob = new Blob([svgString], { type: "image/svg+xml" });
      const url = URL.createObjectURL(blob);
      const img = new Image(size, size);
      img.onload = () => {
        URL.revokeObjectURL(url);
        resolve(img);
      };
      img.src = url;
    });
  }

  const handleResize = () => {
    if (browser) {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
  };

  onMount(async () => {
    if (!browser || !canvas) return;

    ctx = canvas.getContext("2d")!;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Preload all SVG images
    snowflakeImage = await Promise.all(snowflakeSVGs.map((svg) => loadSVGAsImage(svg, 50)));

    const count = Math.round((intensity / 10) * 200);
    for (let i = 0; i < count; i++) {
      snowflakes.push(createSnowflake());
    }

    animate();

    window.addEventListener("resize", handleResize);
  });

  onDestroy(() => {
    if (browser) {
      window.removeEventListener("resize", handleResize);
      cancelAnimationFrame(animationId);
    }
  });

  function animate() {
    if (!ctx || !canvas || !snowflakeImage) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    snowflakes.forEach((flake) => {
      ctx.save();
      ctx.translate(flake.x, flake.y);
      ctx.rotate((flake.rotation * Math.PI) / 180);
      ctx.globalAlpha = 0.8;

      // Draw the SVG image
      const img = snowflakeImage[flake.svgIndex];
      ctx.drawImage(img, -flake.size / 2, -flake.size / 2, flake.size, flake.size);

      ctx.restore();

      flake.y += flake.speed;
      flake.x += flake.wind;
      flake.rotation += flake.rotationSpeed;

      if (flake.y > canvas.height) {
        flake.y = -flake.size;
        flake.x = Math.random() * canvas.width;
      }
    });

    animationId = requestAnimationFrame(animate);
  }
</script>

<Portal to="body" disabled>
  <canvas bind:this={canvas} class="snow-canvas"></canvas>
</Portal>

<style>
  .snow-canvas {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
  }
</style>
